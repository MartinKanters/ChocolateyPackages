name: Update maven-snapshot Chocolatey package
on: [push]
#  schedule: # TODO - revert
#    - cron:  '0 * * * *'
jobs:
  update-package:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Configure Git
        run: |
          git config --global user.email "martinkanters@noreply.github.com"
          git config --global user.name "Martin Kanters"

      - name: Update package if needed
        shell: bash
        run: |
          base_snapshot_url="https://repository.apache.org/content/groups/snapshots/org/apache/maven/apache-maven/"
          latest_version=$(curl -s "${base_snapshot_url}/maven-metadata.xml" | xmllint -xpath '//metadata/versioning/latest/text()' -)
          echo $latest_version
          
      - name: Choco pack and install
        shell: powershell
        env:
          CHOCOLATEY_PACKAGE_API_KEY: ${{ secrets.CHOCOLATEY_PACKAGE_API_KEY }}
          NEW_PACKAGE_VERSION: ${{ env.NEW_PACKAGE_VERSION }}
        run: |
          exit # TODO: remove
          git diff --quiet
          if ($LASTEXITCODE -eq 1) {
            cd maven-snapshot
            
            $orig_mvn_version = mvn -v | Select -First 1
            write-host "Currently installed maven: $orig_mvn_version"
            
            write-host "Choco pack"
            choco pack
            
            write-host "Installing Maven snapshot"
            choco install maven-snapshot -y --no-progress -s .
            
            # Unfortunately choco's `refreshenv` does not work in Github Actions
            $mvn_snapshot_version = C:\ProgramData\chocolatey\lib\maven-snapshot\apache-maven\bin\mvn.cmd -v | Select -First 1
            write-host "Maven-snapshot installed: $mvn_snapshot_version"
            
            if ($orig_mvn_version -eq $mvn_snapshot_version) {
              write-host "Error: Maven Snapshot version is identical to the original Maven version"
              exit 1
            }
            
            choco apikey --key $env:CHOCOLATEY_PACKAGE_API_KEY --source https://push.chocolatey.org/
            choco push maven-snapshot.${env:NEW_PACKAGE_VERSION}.nupkg --source https://push.chocolatey.org/
            
            exit 0
          } else {
            echo "No git changes detected, nothing to do"
          }
         
      - name: Persist changes
        shell: powershell
        run: |
          exit # TODO: remove
          git diff --quiet
          if ($LASTEXITCODE -eq 1) {
            git commit -am "Update to latest Maven snapshot"
            git remote add github "https://${env:GITHUB_ACTOR}:${env:GITHUB_TOKEN}@github.com/${env:GITHUB_REPOSITORY}.git"
            git push github HEAD:${env:GITHUB_REF}
            exit 0
          } else {
            echo "No git changes detected, nothing to do"
          }
